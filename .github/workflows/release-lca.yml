name: Release Please

on:
    push:
        branches:
            - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
    contents: write
    pull-requests: write

env:
    CI: true

jobs:
    release-please:
        runs-on: ubuntu-latest
        name: "Release Please PR"
        outputs:
            lca_release_created: ${{ steps.release.outputs['apps/learn-card-app--release_created'] }}
            lca_version: ${{ steps.release.outputs['apps/learn-card-app--version'] }}
            lca_tag: ${{ steps.release.outputs['apps/learn-card-app--tag_name'] }}
            # TODO: Re-enable scouts outputs after migration testing
            # scouts_release_created: ${{ steps.release.outputs['apps/scouts--release_created'] }}
            # scouts_version: ${{ steps.release.outputs['apps/scouts--version'] }}
            # scouts_tag: ${{ steps.release.outputs['apps/scouts--tag_name'] }}
        steps:
            - name: Check out
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: "${{ secrets.GITHUB_TOKEN }}"

            - name: Git config
              run: |
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"

            - id: release
              uses: googleapis/release-please-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  config-file: release-please-config.json
                  manifest-file: .release-please-manifest.json

    get-capgo-channels:
        name: Extract CapGo Channels
        runs-on: ubuntu-latest
        needs: release-please
        outputs:
            lca_channel: ${{ steps.extract.outputs.lca_channel }}
            # scouts_channel: ${{ steps.extract.outputs.scouts_channel }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install PNPM
              uses: pnpm/action-setup@v3
              with:
                  version: 9
                  run_install: false

            - name: Extract channels
              id: extract
              run: |
                  echo "Extracting CapGo channels..."

                  LCA_CHANNEL=$(node tools/capgo/getCapgoChannel.js --app lca)
                  # TODO: Re-enable after migration testing
                  # SCOUTS_CHANNEL=$(node tools/capgo/getCapgoChannel.js --app scouts)

                  echo "LearnCard Channel: $LCA_CHANNEL"
                  # echo "Scouts Channel: $SCOUTS_CHANNEL"

                  echo "lca_channel=$LCA_CHANNEL" >> $GITHUB_OUTPUT
                  # echo "scouts_channel=$SCOUTS_CHANNEL" >> $GITHUB_OUTPUT

    deploy-lca-capgo:
        needs: [release-please, get-capgo-channels]
        if: needs.release-please.outputs.lca_release_created == 'true'
        uses: ./.github/workflows/capgo-upload.yml
        with:
            project: learn-card-app
            app_id: com.learncard.app
            version: ${{ needs.release-please.outputs.lca_version }}
            build_path: apps/learn-card-app/build
            package_json: apps/learn-card-app/package.json
            node_modules_path: apps/learn-card-app/node_modules
            environment: learn-card-app-production
            channel: ${{ needs.get-capgo-channels.outputs.lca_channel }}
        secrets: inherit

    # TODO: Re-enable scouts CapGo deployment after migration testing
    # deploy-scouts-capgo:
    #     needs: [release-please, get-capgo-channels]
    #     if: needs.release-please.outputs.scouts_release_created == 'true'
    #     uses: ./.github/workflows/capgo-upload.yml
    #     with:
    #         project: scouts
    #         app_id: org.scoutpass.app
    #         version: ${{ needs.release-please.outputs.scouts_version }}
    #         build_path: apps/scouts/build
    #         package_json: apps/scouts/package.json
    #         node_modules_path: apps/scouts/node_modules
    #         environment: scout-app-production
    #         channel: ${{ needs.get-capgo-channels.outputs.scouts_channel }}
    #     secrets: inherit
