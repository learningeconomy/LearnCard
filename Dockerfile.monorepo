# syntax=docker/dockerfile:1.7
FROM node:20.10.0-slim

ENV SKIP_DIDKIT_NAPI=1

WORKDIR /app

RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt \
    apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    build-essential \
    && npm install -g pnpm@9.12.3 \
    && pnpm config set store-dir /pnpm/store

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml nx.json tsconfig.json .npmrc .gitignore .nxignore ./
COPY tools/executors/workspace/run-command tools/executors/workspace/run-command
COPY tools/scripts tools/scripts
RUN chmod +x /app/tools/scripts/nx-watch-build.sh

COPY services/learn-card-network/lca-api/package.json services/learn-card-network/lca-api/
COPY packages/lca-api-client/package.json packages/lca-api-client/
COPY packages/plugins/lca-api-plugin/package.json packages/plugins/lca-api-plugin/
COPY packages/learn-card-helpers/package.json packages/learn-card-helpers/
COPY packages/react-learn-card/package.json packages/react-learn-card/
COPY packages/learn-card-base/package.json packages/learn-card-base/
COPY packages/learn-card-types/package.json packages/learn-card-types/
COPY packages/learn-card-init/package.json packages/learn-card-init/
COPY packages/learn-card-core/package.json packages/learn-card-core/
COPY packages/learn-card-network/brain-client/package.json packages/learn-card-network/brain-client/
COPY packages/learn-card-network/cloud-client/package.json packages/learn-card-network/cloud-client/
COPY packages/learn-card-network/simple-signing-client/package.json packages/learn-card-network/simple-signing-client/
COPY services/learn-card-network/brain-service/package.json services/learn-card-network/brain-service/
COPY services/learn-card-network/learn-cloud-service/package.json services/learn-card-network/learn-cloud-service/
COPY services/learn-card-network/simple-signing-service/package.json services/learn-card-network/simple-signing-service/
COPY packages/plugins/chapi/package.json packages/plugins/chapi/
COPY packages/plugins/crypto/package.json packages/plugins/crypto/
COPY packages/plugins/ceramic/package.json packages/plugins/ceramic/
COPY packages/plugins/idx/package.json packages/plugins/idx/
COPY packages/plugins/didkey/package.json packages/plugins/didkey/
COPY packages/plugins/didkit/package.json packages/plugins/didkit/
COPY packages/plugins/didkit-plugin-node/package.json packages/plugins/didkit-plugin-node/
COPY packages/plugins/did-web-plugin/package.json packages/plugins/did-web-plugin/
COPY packages/plugins/dynamic-loader/package.json packages/plugins/dynamic-loader/
COPY packages/plugins/encryption/package.json packages/plugins/encryption/
COPY packages/plugins/ethereum/package.json packages/plugins/ethereum/
COPY packages/plugins/expiration/package.json packages/plugins/expiration/
COPY packages/plugins/learn-card/package.json packages/plugins/learn-card/
COPY packages/plugins/learn-card-network/package.json packages/plugins/learn-card-network/
COPY packages/plugins/linked-claims/package.json packages/plugins/linked-claims/
COPY packages/plugins/learn-cloud/package.json packages/plugins/learn-cloud/
COPY packages/plugins/open-badge-v2/package.json packages/plugins/open-badge-v2/
COPY packages/plugins/vc/package.json packages/plugins/vc/
COPY packages/plugins/vc-api/package.json packages/plugins/vc-api/
COPY packages/plugins/vc-templates/package.json packages/plugins/vc-templates/
COPY packages/plugins/vpqr/package.json packages/plugins/vpqr/
COPY packages/plugins/simple-signing-plugin/package.json packages/plugins/simple-signing-plugin/
COPY apps/learn-card-app/package.json apps/learn-card-app/
COPY packages/sss-key-manager/package.json packages/sss-key-manager/
COPY packages/auth-types/package.json packages/auth-types/

RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    pnpm install

COPY services/learn-card-network/lca-api services/learn-card-network/lca-api
COPY packages/lca-api-client packages/lca-api-client
COPY packages/plugins/lca-api-plugin packages/plugins/lca-api-plugin
COPY packages/learn-card-helpers packages/learn-card-helpers
COPY packages/react-learn-card packages/react-learn-card
COPY packages/learn-card-base packages/learn-card-base
COPY packages/learn-card-types packages/learn-card-types
COPY packages/learn-card-init packages/learn-card-init
COPY packages/learn-card-core packages/learn-card-core
COPY packages/learn-card-network/brain-client packages/learn-card-network/brain-client
COPY packages/learn-card-network/cloud-client packages/learn-card-network/cloud-client
COPY packages/learn-card-network/simple-signing-client packages/learn-card-network/simple-signing-client
COPY services/learn-card-network/brain-service services/learn-card-network/brain-service
COPY services/learn-card-network/learn-cloud-service services/learn-card-network/learn-cloud-service
COPY services/learn-card-network/simple-signing-service services/learn-card-network/simple-signing-service
COPY packages/plugins/chapi packages/plugins/chapi
COPY packages/plugins/crypto packages/plugins/crypto
COPY packages/plugins/ceramic packages/plugins/ceramic
COPY packages/plugins/idx packages/plugins/idx
COPY packages/plugins/didkey packages/plugins/didkey
COPY packages/plugins/didkit packages/plugins/didkit
COPY packages/plugins/didkit-plugin-node packages/plugins/didkit-plugin-node
COPY packages/plugins/did-web-plugin packages/plugins/did-web-plugin
COPY packages/plugins/dynamic-loader packages/plugins/dynamic-loader
COPY packages/plugins/encryption packages/plugins/encryption
COPY packages/plugins/ethereum packages/plugins/ethereum
COPY packages/plugins/expiration packages/plugins/expiration
COPY packages/plugins/learn-card packages/plugins/learn-card
COPY packages/plugins/learn-card-network packages/plugins/learn-card-network
COPY packages/plugins/linked-claims packages/plugins/linked-claims
COPY packages/plugins/learn-cloud packages/plugins/learn-cloud
COPY packages/plugins/open-badge-v2 packages/plugins/open-badge-v2
COPY packages/plugins/vc packages/plugins/vc
COPY packages/plugins/vc-api packages/plugins/vc-api
COPY packages/plugins/vc-templates packages/plugins/vc-templates
COPY packages/plugins/vpqr packages/plugins/vpqr
COPY packages/plugins/simple-signing-plugin packages/plugins/simple-signing-plugin
COPY apps/learn-card-app apps/learn-card-app
COPY packages/sss-key-manager packages/sss-key-manager
COPY packages/auth-types packages/auth-types

RUN --mount=type=cache,id=nx-cache,target=/app/.nx \
    pnpm exec nx run-many --target=build:docker --projects=learn-card-app,network-brain-service,learn-cloud-service,lca-api-service
