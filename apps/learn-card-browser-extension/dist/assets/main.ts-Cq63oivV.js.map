{"version":3,"file":"main.ts-Cq63oivV.js","sources":["../../src/content/main.ts"],"sourcesContent":["import type { CredentialCandidate } from '../types/messages';\n\n// Minimal VC shape for type guard usage\ntype VerifiableCredential = {\n  '@context': unknown[];\n  type: string | string[];\n  name?: string;\n  [k: string]: unknown;\n};\n\nlet lastSentKey: string | null = null;\nlet observer: MutationObserver | null = null;\nlet listenersAttached = false;\nlet locHookInstalled = false;\n\nconst debounce = (fn: () => void, wait = 200) => {\n  let t: number | undefined;\n  return () => {\n    if (t) window.clearTimeout(t);\n    t = window.setTimeout(fn, wait);\n  };\n};\n\nconst installLocationChangeHook = () => {\n  if (locHookInstalled) return;\n  const pushState = history.pushState;\n  history.pushState = function (this: History, ...args) {\n    const ret = pushState.apply(this, args as unknown as any);\n    window.dispatchEvent(new Event('locationchange'));\n    return ret;\n  } as typeof history.pushState;\n\n  const replaceState = history.replaceState;\n  history.replaceState = function (this: History, ...args) {\n    const ret = replaceState.apply(this, args as unknown as any);\n    window.dispatchEvent(new Event('locationchange'));\n    return ret;\n  } as typeof history.replaceState;\n\n  window.addEventListener('popstate', () => {\n    window.dispatchEvent(new Event('locationchange'));\n  });\n  locHookInstalled = true;\n};\n\nconst detectLinks = (): CredentialCandidate[] => {\n  const anchors = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>('a[href^=\"dccrequest://\"], a[href^=\"msprequest://\"]')\n  );\n\n  const seen = new Set<string>();\n  const platform = /credly\\.com/.test(location.hostname)\n    ? 'credly'\n    : /coursera\\.org/.test(location.hostname)\n    ? 'coursera'\n    : 'unknown';\n\n  const results: CredentialCandidate[] = [];\n  for (const a of anchors) {\n    const href = a.href;\n    if (!href || seen.has(href)) continue;\n    seen.add(href);\n    results.push({\n      source: 'link',\n      url: href,\n      title: a.textContent?.trim() || document.title,\n      platform\n    });\n  }\n\n  return results;\n};\n\nconst isVc = (data: unknown): data is VerifiableCredential => {\n  if (!data || typeof data !== 'object') return false;\n  const obj = data as Record<string, unknown>;\n  const ctx = obj['@context'];\n  const type = obj['type'];\n  return Array.isArray(ctx) && (Array.isArray(type) || typeof type === 'string');\n};\n\nconst detectJsonLd = (): CredentialCandidate[] => {\n  const platform = /credly\\.com/.test(location.hostname)\n    ? 'credly'\n    : /coursera\\.org/.test(location.hostname)\n    ? 'coursera'\n    : 'unknown';\n\n  const results: CredentialCandidate[] = [];\n\n  const addData = (data: unknown) => {\n    if (Array.isArray(data)) {\n      for (const item of data) addData(item);\n      return;\n    }\n    if (isVc(data)) {\n      results.push({\n        source: 'jsonld',\n        raw: data,\n        title: (data as any).name || document.title,\n        platform\n      });\n    }\n  };\n\n  const scripts = Array.from(\n    document.querySelectorAll<HTMLScriptElement>('script[type=\"application/ld+json\"]')\n  );\n\n  for (const s of scripts) {\n    try {\n      const data = JSON.parse(s.textContent || 'null');\n      if (!data) continue;\n      addData(data);\n    } catch {}\n  }\n\n  const potentialScripts = Array.from(document.querySelectorAll('pre, code'));\n\n  for (const s of potentialScripts) {\n    const text = s.textContent;\n    if (!text) continue;\n    // Heuristic check: Does it contain key VC terms? This avoids trying to parse every code snippet.\n    if (text.includes('\"VerifiableCredential\"') && text.includes('\"credentialSubject\"')) {\n      try {\n        const data = JSON.parse(text);\n        addData(data);\n      } catch (e) {\n        /* Ignore elements with malformed JSON */\n      }\n    }\n  }\n\n  return results;\n};\n\nconst runDetection = () => {\n  const links = detectLinks();\n  const jsonld = detectJsonLd();\n  const map = new Map<string, CredentialCandidate>();\n\n  const platform = /credly\\.com/.test(location.hostname)\n    ? 'credly'\n    : /coursera\\.org/.test(location.hostname)\n    ? 'coursera'\n    : 'unknown';\n\n  const hash = (c: CredentialCandidate) => {\n    if (c.url) return `url:${c.url}`;\n    try {\n      return `raw:${JSON.stringify(c.raw)}`;\n    } catch {\n      return `raw:${String(c.title ?? '')}:${platform}`;\n    }\n  };\n\n  for (const c of [...links, ...jsonld]) {\n    const key = hash(c);\n    if (!map.has(key)) map.set(key, c);\n  }\n\n  const list = Array.from(map.values());\n  const newKey = `${list.length}:${Array.from(map.keys()).sort().join('|')}`;\n  if (newKey === lastSentKey) return;\n  lastSentKey = newKey;\n\n  chrome.runtime.sendMessage({ type: 'credentials-detected', payload: list });\n};\n\nconst startObserving = () => {\n  if (!observer) {\n    const debounced = debounce(runDetection, 200);\n    observer = new MutationObserver(() => {\n      debounced();\n    });\n    observer.observe(document.documentElement, {\n      childList: true,\n      subtree: true,\n      attributes: true,\n      attributeFilter: ['href']\n    });\n  }\n\n  if (!listenersAttached) {\n    installLocationChangeHook();\n    const resetAndScan = () => {\n      lastSentKey = null;\n      if (!observer) startObserving();\n      runDetection();\n    };\n    // React to SPA route changes\n    window.addEventListener('hashchange', resetAndScan);\n    window.addEventListener('locationchange', resetAndScan);\n    // When tab becomes visible again, try a scan\n    document.addEventListener('visibilitychange', () => {\n      if (document.visibilityState === 'visible') runDetection();\n    });\n    listenersAttached = true;\n  }\n};\n\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', () => {\n    runDetection();\n    startObserving();\n  });\n} else {\n  runDetection();\n  startObserving();\n}\n"],"names":["lastSentKey","observer","listenersAttached","locHookInstalled","debounce","fn","wait","installLocationChangeHook","pushState","args","ret","replaceState","detectLinks","anchors","seen","platform","results","a","href","isVc","data","obj","ctx","type","detectJsonLd","addData","item","scripts","s","potentialScripts","text","runDetection","links","jsonld","map","hash","key","list","newKey","startObserving","debounced","resetAndScan"],"mappings":"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"}