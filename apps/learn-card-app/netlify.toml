#############################################
##  Configuration for Netlify deployments  ##
#############################################

[build.environment]
PNPM_FLAGS = "-P false"
SKIP_DIDKIT_NAPI = "1"
# Global Context Default
[build]
command = "pnpm exec nx build learn-card-app --skip-nx-cache"
publish = "build/"

# Netlify Deploy Preview
[context.deploy-preview]
environment = { NODE_ENV = 'staging', VITE_NODE_ENV = "staging-learncardapp", NETLIFY_BUILD_TYPE = "deploy-preview", SENTRY_ENV="deploy-preview", SENTRY_DSN='https://68210fb71359458b9746c55cf5f545b4@o246842.ingest.us.sentry.io/4505432118984704' }

# Production LearnCard
[context.main]
environment = {NODE_ENV = 'production', VITE_NODE_ENV = "production-learncardapp", NETLIFY_BUILD_TYPE = "live", SENTRY_ENV="production", SENTRY_DSN='https://68210fb71359458b9746c55cf5f545b4@o246842.ingest.us.sentry.io/4505432118984704' }

[dev]
targetPort = 3001
port = 8888
environment = { LCN_API_URL = "http://localhost:4000/api" }
###################################
#      Redirects + Headers        #
###################################
# Redirects and headers are GLOBAL for all builds. For context-specific
# rules, use _headers or _redirects files, which are PER-DEPLOY.

[[redirects]] # For use with SPAs that handle routing internally
from = "/*"
to = "/index.html"
status = 200

[redirects.headers]
X-From = "Netlify"

# Edge Handler declaration
[[edge_handlers]]
path = "/*"
handler = "filterRequests"

[[edge_functions]]
path = "/interactions/*"
function = "interact"


[[headers]]
for = "/.well-known/apple-app-site-association"
[headers.values]
Cache-Control = "public, max-age=0"
Content-Type = "application/json"
X-Content-Type-Options = "nosniff"

[[headers]]
for = "/manifest.json"
[headers.values]
Access-Control-Allow-Origin = "*"

[[headers]]
for = "/*"
[headers.values]
Access-Control-Allow-Origin = "*"

[[headers]]
for = "/assets/icon/icon.png"
[headers.values]
Access-Control-Allow-Origin = "*"

[[headers]]
for = "/assets/icon/favicon.png"
[headers.values]
Access-Control-Allow-Origin = "*"

[[headers]]
  for = "/assets/*.wasm"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Long-cache hashed assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Access-Control-Allow-Origin = "*"    

# Never cache HTML so a full reload picks up the latest shell
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "no-cache"